@page "/chatroom"

@using Microsoft.AspNetCore.Components
@using WebSocketDemo.Shared.Models
@using WebSocketDemo.Shared.Services
@using WebSocketDemo.Client.Services
@inject IWebSocketService WebSocketService
@inject NavigationManager NavigationManager
@inject LocalStorageService LocalStorageService
@inject IConsoleLogger Logger

<PageTitle>聊天室 - WebSocket Demo</PageTitle>

<div class="chatroom-container">
    <!-- 顶部标题栏 -->
    <div class="chatroom-header">
        <h1>WebSocket 聊天室</h1>
        <div class="connection-status">
            @if (IsConnected)
            {
                <span class="status-connected">● 已连接</span>
                <span class="online-count">在线用户: @OnlineUsersCount</span>
                <button class="btn btn-outline-danger btn-sm" @onclick="Disconnect">断开连接</button>
            }
            else
            {
                <span class="status-disconnected">● 未连接</span>
                <button class="btn btn-primary btn-sm" @onclick="ShowConnectDialog">连接聊天室</button>
            }
        </div>
    </div>

    <!-- 主要内容区域 -->
    <div class="chatroom-main">
        <!-- 聊天消息区域 -->
        <div class="chat-messages-container">
            <div class="chat-messages-header">
                <h3>聊天消息</h3>
                <div class="message-controls">
                    <button class="btn btn-outline-secondary btn-sm" @onclick="ClearMessages" disabled="@(!_messages.Any())" title="清空当前聊天记录">
                        清空消息
                    </button>
                    <button class="btn btn-outline-info btn-sm" @onclick="ClearMessageHistory" disabled="@(!HasMessageHistory)" title="清除本地存储的聊天记录">
                        清除历史
                    </button>
                </div>
            </div>

            <div class="chat-messages" @ref="_messagesContainer">
                @if (_messages.Count == 0)
                {
                    <div class="no-messages">
                        <p>暂无消息，发送第一条消息开始聊天吧！</p>
                    </div>
                }
                else
                {
                    @foreach (var message in _messages)
                    {
                        <div class="message-item @GetMessageCssClass(message)">
                            <div class="message-header">
                                <span class="message-username">@message.UserName</span>
                                <span class="message-timestamp">@message.Timestamp.ToLocalTime().ToString("HH:mm:ss")</span>
                                @if (message.MessageType != MessageType.TextMessage)
                                {
                                    <span class="message-type">[@GetMessageTypeText(message.MessageType)]</span>
                                }
                            </div>
                            <div class="message-content">@message.Content</div>
                        </div>
                    }
                }
            </div>
        </div>

        <!-- 在线用户列表 -->
        <div class="online-users-container">
            <div class="online-users-header">
                <h3>在线用户 (@OnlineUsersCount)</h3>
            </div>
            <div class="online-users-list">
                @if (_onlineUsers.Count == 0)
                {
                    <div class="no-users">
                        <p>暂无在线用户</p>
                    </div>
                }
                else
                {
                    @foreach (var user in _onlineUsers)
                    {
                        <div class="user-item @(user.IsOnline ? "user-online" : "user-offline")">
                            <span class="user-status">●</span>
                            <span class="user-name">@user.UserName</span>
                            @if (user.UserId == WebSocketService.CurrentUser?.UserId)
                            {
                                <span class="user-me">(我)</span>
                            }
                        </div>
                    }
                }
            </div>
        </div>
    </div>

    <!-- 消息输入区域 -->
    <div class="message-input-container">
        <div class="input-group">
            <input
                type="text"
                class="form-control"
                placeholder="输入消息..."
                @bind="_inputMessage"
                @bind:event="oninput"
                @onkeyup="HandleKeyUp"
                disabled="@(!IsConnected)"
                @ref="_messageInput" />
            <button
                class="btn btn-primary"
                @onclick="SendMessage"
                disabled="@(string.IsNullOrWhiteSpace(_inputMessage) || !IsConnected)">
                发送
            </button>
        </div>
        <div class="input-hint">
            @if (!IsConnected)
            {
                <span class="text-warning">请先连接聊天室</span>
            }
            else if (string.IsNullOrWhiteSpace(_inputMessage))
            {
                <span class="text-muted">输入消息后点击发送或按Enter键</span>
            }
            else
            {
                <span class="text-success">按Enter键发送消息</span>
            }
        </div>
    </div>

    <!-- 错误提示 -->
    @if (!string.IsNullOrEmpty(_errorMessage))
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @_errorMessage
            <button type="button" class="btn-close" @onclick="ClearError"></button>
        </div>
    }

    <!-- 连接对话框 -->
    @if (_showConnectDialog)
    {
        <div class="modal-overlay">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">连接到聊天室</h5>
                        <button type="button" class="btn-close" @onclick="CloseConnectDialog"></button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="username">用户名</label>
                            <input
                                type="text"
                                class="form-control"
                                id="username"
                                @bind="_inputUserName"
                                @bind:event="oninput"
                                placeholder="请输入用户名"
                                @onkeyup="HandleConnectKeyUp" />
                            <small class="form-text text-muted">如果不输入，将使用随机用户名</small>
                        </div>
                        <div class="form-group mt-3">
                            <label for="serverUrl">服务器地址</label>
                            <select class="form-control" id="serverUrl" @bind="_selectedServerUrl">
                                <option value="ws://localhost:5015/ws">ws://localhost:5015/ws (HTTP)</option>
                                <option value="wss://localhost:7235/ws">wss://localhost:7235/ws (HTTPS)</option>
                            </select>
                            <small class="form-text text-muted">选择要连接的服务器地址</small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" @onclick="CloseConnectDialog">取消</button>
                        <button type="button" class="btn btn-primary" @onclick="ConnectToChat" disabled="@string.IsNullOrWhiteSpace(_inputUserName)">
                            连接
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private List<ChatMessage> _messages = new();
    private List<UserInfo> _onlineUsers = new();
    private string _inputMessage = string.Empty;
    private string _inputUserName = string.Empty;
    private string _selectedServerUrl = "ws://localhost:5015/ws";
    private string _errorMessage = string.Empty;
    private bool _showConnectDialog = false;
    private ElementReference _messagesContainer;
    private ElementReference _messageInput;
    private bool _isConnecting = false;

    public bool IsConnected => WebSocketService.IsConnected;
    public int OnlineUsersCount => _onlineUsers.Count;
    public bool HasMessageHistory { get; private set; }

    protected override async Task OnInitializedAsync()
    {
        // 订阅WebSocket服务事件
        WebSocketService.MessageReceived += OnMessageReceived;
        WebSocketService.OnlineUsersUpdated += OnOnlineUsersUpdated;
        WebSocketService.ConnectionStateChanged += OnConnectionStateChanged;
        WebSocketService.ErrorOccurred += OnErrorOccurred;

        // 加载保存的用户设置
        await LoadUserSettingsAsync();

        // 加载消息历史
        await LoadMessageHistoryAsync();

        // 如果没有连接，显示连接对话框
        if (!IsConnected)
        {
            _showConnectDialog = true;
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // 自动滚动到最新消息
            await ScrollToBottom();
        }
    }

    private async Task ScrollToBottom()
    {
        try
        {
            await _messagesContainer.FocusAsync();
        }
        catch (Exception)
        {
            // 忽略滚动错误
        }
    }

    private void ShowConnectDialog()
    {
        _showConnectDialog = true;
        StateHasChanged();
    }

    private void CloseConnectDialog()
    {
        _showConnectDialog = false;
        StateHasChanged();
    }

    private async Task ConnectToChat()
    {
        if (_isConnecting) return;

        _isConnecting = true;
        _errorMessage = string.Empty;

        try
        {
            var userName = string.IsNullOrWhiteSpace(_inputUserName)
                ? $"用户_{Guid.NewGuid().ToString()[..6]}"
                : _inputUserName;

            await WebSocketService.ConnectAsync(_selectedServerUrl, userName);
            _showConnectDialog = false;

            // 保存用户设置
            await SaveUserSettingsAsync();

            // 添加欢迎消息
            var welcomeMessage = ChatMessage.CreateSystemMessage($"欢迎 {userName} 加入聊天室！");
            _messages.Add(welcomeMessage);

            // 保存消息到历史记录
            await SaveMessageToHistoryAsync(welcomeMessage);

            await ScrollToBottom();
        }
        catch (Exception ex)
        {
            _errorMessage = $"连接失败: {ex.Message}";
        }
        finally
        {
            _isConnecting = false;
            StateHasChanged();
        }
    }

    private async Task Disconnect()
    {
        try
        {
            await WebSocketService.DisconnectAsync();

            // 保存当前消息历史
            await SaveMessageHistoryAsync();

            _messages.Clear();
            _onlineUsers.Clear();
        }
        catch (Exception ex)
        {
            _errorMessage = $"断开连接失败: {ex.Message}";
        }
    }

    private async Task SendMessage()
    {
        if (string.IsNullOrWhiteSpace(_inputMessage) || !IsConnected)
            return;

        try
        {
            await WebSocketService.SendMessageAsync(_inputMessage);
            _inputMessage = string.Empty;
            await _messageInput.FocusAsync();
        }
        catch (Exception ex)
        {
            _errorMessage = $"发送消息失败: {ex.Message}";
        }
    }

    private async Task ClearMessages()
    {
        _messages.Clear();
        StateHasChanged();
    }

    private async Task ClearMessageHistory()
    {
        try
        {
            await LocalStorageService.RemoveItemAsync("chat_messages");
            HasMessageHistory = false;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            _errorMessage = $"清除历史记录失败: {ex.Message}";
        }
    }

    private void ClearError()
    {
        _errorMessage = string.Empty;
        StateHasChanged();
    }

    private void HandleKeyUp(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !string.IsNullOrWhiteSpace(_inputMessage) && IsConnected)
        {
            _ = SendMessage();
        }
    }

    private void HandleConnectKeyUp(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !string.IsNullOrWhiteSpace(_inputUserName))
        {
            _ = ConnectToChat();
        }
    }

    private string GetMessageCssClass(ChatMessage message)
    {
        return message.MessageType switch
        {
            MessageType.SystemNotification => "message-system",
            MessageType.UserJoined => "message-user-joined",
            MessageType.UserLeft => "message-user-left",
            MessageType.Error => "message-error",
            _ => message.UserId == WebSocketService.CurrentUser?.UserId ? "message-self" : "message-other"
        };
    }

    private string GetMessageTypeText(MessageType messageType)
    {
        return messageType switch
        {
            MessageType.SystemNotification => "系统",
            MessageType.UserJoined => "加入",
            MessageType.UserLeft => "离开",
            MessageType.Error => "错误",
            _ => "消息"
        };
    }

    private async void OnMessageReceived(ChatMessage message)
    {
        _messages.Add(message);
        StateHasChanged();

        // 保存消息到历史记录
        await SaveMessageToHistoryAsync(message);

        _ = ScrollToBottom();
    }

    private void OnOnlineUsersUpdated(UserInfo[] users)
    {
        _onlineUsers = new List<UserInfo>(users);
        StateHasChanged();
    }

    private void OnConnectionStateChanged(bool isConnected)
    {
        if (!isConnected)
        {
            // 连接断开时，显示系统消息
            _messages.Add(ChatMessage.CreateSystemMessage("连接已断开"));
            _onlineUsers.Clear();
        }
        StateHasChanged();
    }

    private async void OnErrorOccurred(string errorMessage)
    {
        _errorMessage = errorMessage;
        var errorSystemMessage = ChatMessage.CreateSystemMessage($"错误: {errorMessage}");
        _messages.Add(errorSystemMessage);
        StateHasChanged();

        // 保存错误消息到历史记录
        await SaveMessageToHistoryAsync(errorSystemMessage);

        _ = ScrollToBottom();
    }

    public void Dispose()
    {
        // 取消订阅事件
        WebSocketService.MessageReceived -= OnMessageReceived;
        WebSocketService.OnlineUsersUpdated -= OnOnlineUsersUpdated;
        WebSocketService.ConnectionStateChanged -= OnConnectionStateChanged;
        WebSocketService.ErrorOccurred -= OnErrorOccurred;
    }

    private async Task LoadUserSettingsAsync()
    {
        try
        {
            var settings = await LocalStorageService.GetObjectAsync<UserSettings>("user_settings");
            if (settings != null)
            {
                _inputUserName = settings.UserName;
                _selectedServerUrl = settings.ServerUrl;
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Logger.Error($"加载用户设置失败: {ex.Message}", ex);
        }
    }

    private async Task SaveUserSettingsAsync()
    {
        try
        {
            var settings = new UserSettings
            {
                UserName = _inputUserName,
                ServerUrl = _selectedServerUrl,
                AutoConnect = false,
                Theme = "light",
                EnableNotifications = true,
                EnableSound = true
            };
            await LocalStorageService.SetObjectAsync("user_settings", settings);
        }
        catch (Exception ex)
        {
            Logger.Error($"保存用户设置失败: {ex.Message}", ex);
        }
    }

    private async Task LoadMessageHistoryAsync()
    {
        try
        {
            var savedMessages = await LocalStorageService.GetObjectAsync<List<ChatMessage>>("chat_messages");
            if (savedMessages != null && savedMessages.Count > 0)
            {
                // 限制历史消息数量，避免加载过多
                var recentMessages = savedMessages.TakeLast(50).ToList();
                _messages.AddRange(recentMessages);
                HasMessageHistory = true;
                StateHasChanged();
                await ScrollToBottom();
            }
        }
        catch (Exception ex)
        {
            Logger.Error($"加载消息历史失败: {ex.Message}", ex);
        }
    }

    private async Task SaveMessageHistoryAsync()
    {
        try
        {
            if (_messages.Count > 0)
            {
                await LocalStorageService.SetObjectAsync("chat_messages", _messages);
                HasMessageHistory = true;
            }
        }
        catch (Exception ex)
        {
            Logger.Error($"保存消息历史失败: {ex.Message}", ex);
        }
    }

    private async Task SaveMessageToHistoryAsync(ChatMessage message)
    {
        try
        {
            // 获取现有历史记录
            var savedMessages = await LocalStorageService.GetObjectAsync<List<ChatMessage>>("chat_messages")
                ?? new List<ChatMessage>();

            // 添加新消息
            savedMessages.Add(message);

            // 限制历史记录大小（最多保存100条消息）
            if (savedMessages.Count > 100)
            {
                savedMessages = savedMessages.Skip(savedMessages.Count - 100).ToList();
            }

            await LocalStorageService.SetObjectAsync("chat_messages", savedMessages);
            HasMessageHistory = true;
        }
        catch (Exception ex)
        {
            Logger.Error($"保存消息到历史记录失败: {ex.Message}", ex);
        }
    }
}

<style>
    .chatroom-container {
        display: flex;
        flex-direction: column;
        height: 100vh;
        max-width: 1200px;
        margin: 0 auto;
        padding: 1rem;
        background-color: #f8f9fa;
    }

    .chatroom-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem;
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 1rem;
    }

    .chatroom-header h1 {
        margin: 0;
        font-size: 1.5rem;
        color: #333;
    }

    .connection-status {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .status-connected {
        color: #28a745;
        font-weight: bold;
    }

    .status-disconnected {
        color: #dc3545;
        font-weight: bold;
    }

    .online-count {
        color: #6c757d;
    }

    .chatroom-main {
        display: flex;
        flex: 1;
        gap: 1rem;
        overflow: hidden;
    }

    .chat-messages-container {
        flex: 3;
        display: flex;
        flex-direction: column;
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        overflow: hidden;
    }

    .chat-messages-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem;
        border-bottom: 1px solid #dee2e6;
        background-color: #f8f9fa;
    }

    .chat-messages-header h3 {
        margin: 0;
        font-size: 1.25rem;
    }

    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 1rem;
    }

    .no-messages {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100%;
        color: #6c757d;
        text-align: center;
    }

    .message-item {
        margin-bottom: 1rem;
        padding: 0.75rem;
        border-radius: 8px;
        animation: fadeIn 0.3s ease-in;
    }

    .message-self {
        background-color: #e3f2fd;
        border-left: 4px solid #2196f3;
    }

    .message-other {
        background-color: #f5f5f5;
        border-left: 4px solid #9e9e9e;
    }

    .message-system {
        background-color: #fff8e1;
        border-left: 4px solid #ffc107;
    }

    .message-user-joined {
        background-color: #e8f5e9;
        border-left: 4px solid #4caf50;
    }

    .message-user-left {
        background-color: #ffebee;
        border-left: 4px solid #f44336;
    }

    .message-error {
        background-color: #ffebee;
        border-left: 4px solid #f44336;
        color: #c62828;
    }

    .message-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.25rem;
        font-size: 0.85rem;
    }

    .message-username {
        font-weight: bold;
        color: #333;
    }

    .message-timestamp {
        color: #6c757d;
    }

    .message-type {
        color: #6c757d;
        font-style: italic;
    }

    .message-content {
        word-wrap: break-word;
        line-height: 1.5;
    }

    .online-users-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        overflow: hidden;
        min-width: 250px;
    }

    .online-users-header {
        padding: 1rem;
        border-bottom: 1px solid #dee2e6;
        background-color: #f8f9fa;
    }

    .online-users-header h3 {
        margin: 0;
        font-size: 1.25rem;
    }

    .online-users-list {
        flex: 1;
        overflow-y: auto;
        padding: 1rem;
    }

    .no-users {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100%;
        color: #6c757d;
        text-align: center;
    }

    .user-item {
        display: flex;
        align-items: center;
        padding: 0.5rem;
        margin-bottom: 0.5rem;
        border-radius: 4px;
        transition: background-color 0.2s;
    }

    .user-item:hover {
        background-color: #f8f9fa;
    }

    .user-online .user-status {
        color: #28a745;
        margin-right: 0.5rem;
    }

    .user-offline .user-status {
        color: #dc3545;
        margin-right: 0.5rem;
    }

    .user-name {
        flex: 1;
        font-weight: 500;
    }

    .user-me {
        color: #2196f3;
        font-size: 0.85rem;
    }

    .message-input-container {
        margin-top: 1rem;
        padding: 1rem;
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .input-group {
        display: flex;
        gap: 0.5rem;
    }

    .input-group input {
        flex: 1;
    }

    .input-hint {
        margin-top: 0.5rem;
        font-size: 0.85rem;
        text-align: center;
    }

    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0,0,0,0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }

    .modal-dialog {
        width: 100%;
        max-width: 500px;
    }

    .modal-content {
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }

    .modal-header {
        padding: 1rem;
        border-bottom: 1px solid #dee2e6;
    }

    .modal-body {
        padding: 1rem;
    }

    .modal-footer {
        padding: 1rem;
        border-top: 1px solid #dee2e6;
        display: flex;
        justify-content: flex-end;
        gap: 0.5rem;
    }

    .alert {
        position: fixed;
        top: 1rem;
        right: 1rem;
        z-index: 1050;
        max-width: 400px;
    }

    @@keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @@media (max-width: 768px) {
        .chatroom-main {
            flex-direction: column;
        }

        .online-users-container {
            min-width: unset;
        }

        .chatroom-header {
            flex-direction: column;
            gap: 1rem;
            text-align: center;
        }
    }
</style>
